#!/bin/bash

set -e

# Members
n=$1
[ -z "$n" ] || shift
[ -z "$n" ] && n=3

# CALs
c=$1
[ -z "$c" ] || shift
[ -z "$c" ] && c=0

which seq  && seq=seq
which gseq && seq=gseq

open=open
which xdg-open >/dev/null && open=xdg-open

if [ -z "$seq" ]
then
    printf 'Could not find `seq` or `gseq`\n'
    exit 1
fi

waitall() {
    while test $running -ge 1
    do
        wait
        running=$(expr $running - 1)
    done
}

quit() {
    killall doozerd
    waitall
}

trap quit INT

running=0
for i in $($seq $n)
do
    bin/fr $i &
    running=$(expr $running + 1)

    sleep 1
done

for i in $($seq $c)
do
    bin/dcmd SET /doozer/slot/$i '' 0
done

$open http://127.0.0.1:8081

waitall
